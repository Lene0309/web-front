<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售统计分析</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
    <script src="../axios.min.js"></script>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --warning-color: #E6A23C;
            --danger-color: #F56C6C;
            --info-color: #909399;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .app-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e6e6e6;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }
        
        .search-container {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
        }
        
        .statistics-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #fff;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.08);
        }
        
        .stat-card-header {
            font-size: 14px;
            color: #909399;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-card-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .stat-card-footer {
            font-size: 13px;
            color: #909399;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-box {
            background: #fff;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
            height: 400px;
        }
        
        .top10-chart-box {
            background: #fff;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
            height: 500px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }
        
        .chart-content {
            width: 100%;
            height: calc(100% - 40px);
        }
        
        .growth-positive {
            color: var(--success-color);
        }
        
        .growth-negative {
            color: var(--danger-color);
        }
        
        .total-sales {
            color: var(--primary-color);
        }
        
        .total-orders {
            color: var(--success-color);
        }
        
        .avg-price {
            color: var(--warning-color);
        }
        
        .total-customers {
            color: var(--danger-color);
        }
        
        .empty-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #909399;
            font-size: 16px;
        }
    </style>
</head>
<body style="margin:0;">
    <div id="app-layout" style="display: flex; height: 100vh;">
        <!-- 侧边导航栏 -->
        <div style="width:220px; min-height:100vh; background:#2d3a4b; display:flex; flex-direction:column; box-shadow:2px 0 8px rgba(0,0,0,0.08);">
            <div style="height:64px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:20px; font-weight:bold; letter-spacing:2px;">
                管理后台
            </div>
            <el-menu
                :default-active="activeMenu"
                class="el-menu-vertical-demo"
                background-color="#2d3a4b"
                text-color="#fff"
                active-text-color="#ffd04b"
                style="border-right:none; flex:1;"
                @select="handleMenuSelect">
                <el-menu-item index="productList.html">
                    <i class="el-icon-goods"></i>
                    <span slot="title">商品管理</span>
                </el-menu-item>
                <el-menu-item index="orderList.html">
                    <i class="el-icon-document"></i>
                    <span slot="title">订单管理</span>
                </el-menu-item>
                <el-menu-item index="CustomerList.html">
                    <i class="el-icon-user"></i>
                    <span slot="title">客户管理</span>
                </el-menu-item>
                <el-menu-item index="deliveryList.html">
                    <i class="el-icon-truck"></i>
                    <span slot="title">配送管理</span>
                </el-menu-item>
                <el-menu-item index="stockManagement.html">
                    <i class="el-icon-box"></i>
                    <span slot="title">库存管理</span>
                </el-menu-item>
                <el-menu-item index="statistics.html">
                    <i class="el-icon-s-data"></i>
                    <span slot="title">销售统计</span>
                </el-menu-item>
            </el-menu>
        </div>
        <!-- 主内容区 -->
        <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; min-width:0;">
            <!-- 顶部栏 -->
            <div style="height: 64px; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; border-bottom: 1px solid #eee; background:#fff;">
                <el-dropdown @command="handleCommand">
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <el-avatar icon="el-icon-user-solid"></el-avatar>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
            <!-- 内容区 -->
            <div style="flex:1; padding:32px; overflow:auto; min-width:0;">
                <div id="app" class="app-container">
                    <div class="page-header">
                        <h1 class="page-title">销售统计分析</h1>
                    </div>
                    
                    <div class="search-container">
                        <el-form :inline="true" :model="searchForm" class="demo-form-inline">
                            <el-form-item label="统计时间">
                                <el-date-picker
                                    v-model="searchForm.dateRange"
                                    type="daterange"
                                    range-separator="至"
                                    start-placeholder="开始日期"
                                    end-placeholder="结束日期"
                                    value-format="yyyy-MM-dd"
                                    :picker-options="pickerOptions">
                                </el-date-picker>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleSearch" :loading="loading">
                                    <i class="el-icon-search"></i> 查询
                                </el-button>
                                <el-button @click="resetSearch">
                                    <i class="el-icon-refresh"></i> 重置
                                </el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                    
                    <div class="statistics-container">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span>总销售额</span>
                                <i class="el-icon-s-data"></i>
                            </div>
                            <div class="stat-card-value total-sales">¥{{ statistics.totalSales | currency }}</div>
                            <div class="stat-card-footer"></div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span>总订单数</span>
                                <i class="el-icon-document"></i>
                            </div>
                            <div class="stat-card-value total-orders">{{ statistics.totalOrders }}</div>
                            
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span>平均客单价</span>
                                <i class="el-icon-money"></i>
                            </div>
                            <div class="stat-card-value avg-price">¥{{ statistics.avgPrice | currency }}</div>
                            
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <span>客户数</span>
                                <i class="el-icon-user"></i>
                            </div>
                            <div class="stat-card-value total-customers">{{ statistics.totalCustomers }}</div>
                            
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-box">
                            <div class="chart-title">销售趋势</div>
                            <div id="salesTrendChart" class="chart-content">
                                <div v-if="!hasTrendData" class="empty-data">暂无销售趋势数据</div>
                            </div>
                        </div>
                        
                        <div class="chart-box">
                            <div class="chart-title">品类销售占比</div>
                            <div id="salesCategoryChart" class="chart-content">
                                <div v-if="!hasCategoryData" class="empty-data">暂无品类销售数据</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="top10-chart-box">
                        <div class="chart-title">热销商品TOP10</div>
                        <div id="salesTop10Chart" class="chart-content">
                            <div v-if="!hasTopProductsData" class="empty-data">暂无热销商品数据</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        Vue.use(ELEMENT);
        axios.defaults.baseURL = 'http://localhost:9000';
        axios.defaults.withCredentials = true;
        
        new Vue({
            el: "#app-layout",
            data() {
                return {
                    activeMenu: 'statistics.html',
                    loading: false,
                    searchForm: {
                        dateRange: []
                    },
                    pickerOptions: {
                        shortcuts: [{
                            text: '最近一周',
                            onClick(picker) {
                                const end = new Date();
                                const start = new Date();
                                start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                                picker.$emit('pick', [start, end]);
                            }
                        }, {
                            text: '最近一个月',
                            onClick(picker) {
                                const end = new Date();
                                const start = new Date();
                                start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                                picker.$emit('pick', [start, end]);
                            }
                        }, {
                            text: '最近三个月',
                            onClick(picker) {
                                const end = new Date();
                                const start = new Date();
                                start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                                picker.$emit('pick', [start, end]);
                            }
                        }]
                    },
                    statistics: {
                        totalSales: 0,
                        salesGrowthRate: 0,
                        totalOrders: 0,
                        orderGrowthRate: 0,
                        avgPrice: 0,
                        avgPriceGrowthRate: 0,
                        totalCustomers: 0,
                        customerGrowthRate: 0
                    },
                    salesTrendChart: null,
                    salesCategoryChart: null,
                    salesTop10Chart: null,
                    // 数据状态标志
                    hasTrendData: false,
                    hasCategoryData: false,
                    hasTopProductsData: false
                }
            },
            computed: {
                formattedDateRange() {
                    if (!this.searchForm.dateRange || this.searchForm.dateRange.length < 2) {
                        return '全部时间';
                    }
                    return `${this.searchForm.dateRange[0]} 至 ${this.searchForm.dateRange[1]}`;
                }
            },
            filters: {
                currency(value) {
                    if (!value && value !== 0) return '0.00';
                    return parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                percentage(value) {
                    if (!value && value !== 0) return '0.00%';
                    return parseFloat(value).toFixed(2) + '%';
                }
            },
            mounted() {
                this.initCharts();
                // 默认查询最近30天数据
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 30);
                
                this.searchForm.dateRange = [
                    this.formatDate(startDate),
                    this.formatDate(endDate)
                ];
                
                this.getStatistics();
                // 激活菜单
                this.activeMenu = 'statistics.html';
            },
            methods: {
                formatDate(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                initCharts() {
                    // 销售趋势图
                    this.salesTrendChart = echarts.init(document.getElementById('salesTrendChart'));
                    this.salesTrendChart.setOption({
                        title: {
                            text: '',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                
                                let result = params[0].axisValue + '<br/>';
                                params.forEach(item => {
                                    if (item.value !== undefined && item.value !== null) {
                                        result += `${item.seriesName}: ${item.seriesType === 'line' ? '¥' : ''}${parseFloat(item.value).toFixed(2)}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['销售额', '订单数'],
                            bottom: 10
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '15%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            axisLine: {
                                lineStyle: {
                                    color: '#dcdfe6'
                                }
                            },
                            axisLabel: {
                                color: '#606266'
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '销售额',
                                axisLabel: {
                                    formatter: '¥{value}',
                                    color: '#606266'
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#dcdfe6'
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: ['#ebeef5']
                                    }
                                }
                            },
                            {
                                type: 'value',
                                name: '订单数',
                                axisLabel: {
                                    color: '#606266'
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#dcdfe6'
                                    }
                                },
                                splitLine: {
                                    show: false
                                }
                            }
                        ],
                        series: [
                            {
                                name: '销售额',
                                type: 'line',
                                smooth: true,
                                lineStyle: {
                                    width: 3,
                                    color: '#409EFF'
                                },
                                itemStyle: {
                                    color: '#409EFF'
                                },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {
                                            offset: 0,
                                            color: 'rgba(64, 158, 255, 0.5)'
                                        },
                                        {
                                            offset: 1,
                                            color: 'rgba(64, 158, 255, 0.1)'
                                        }
                                    ])
                                },
                                data: []
                            },
                            {
                                name: '订单数',
                                type: 'line',
                                yAxisIndex: 1,
                                smooth: true,
                                lineStyle: {
                                    width: 3,
                                    color: '#67C23A'
                                },
                                itemStyle: {
                                    color: '#67C23A'
                                },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {
                                            offset: 0,
                                            color: 'rgba(103, 194, 58, 0.5)'
                                        },
                                        {
                                            offset: 1,
                                            color: 'rgba(103, 194, 58, 0.1)'
                                        }
                                    ])
                                },
                                data: []
                            }
                        ]
                    });
                    
                    // 销售品类占比
                    this.salesCategoryChart = echarts.init(document.getElementById('salesCategoryChart'));
                    this.salesCategoryChart.setOption({
                        title: {
                            text: '',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function(params) {
                                if (!params || !params.data || params.data.value === undefined) return '';
                                return `${params.seriesName} <br/>${params.name}: ¥${parseFloat(params.data.value).toFixed(2)} (${params.percent}%)`;
                            }
                        },
                        legend: {
                            orient: 'vertical',
                            right: 10,
                            top: 'center',
                            textStyle: {
                                color: '#606266'
                            },
                            data: []
                        },
                        series: [
                            {
                                name: '销售占比',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                center: ['40%', '50%'],
                                avoidLabelOverlap: false,
                                itemStyle: {
                                    borderRadius: 10,
                                    borderColor: '#fff',
                                    borderWidth: 2
                                },
                                label: {
                                    show: false,
                                    position: 'center',
                                    formatter: function(params) {
                                        return params.name ? `${params.name}\n${params.percent}%` : '';
                                    }
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: '18',
                                        fontWeight: 'bold'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: []
                            }
                        ],
                        color: ['#409EFF', '#67C23A', '#E6A23C', '#F56C6C', '#909399', '#c23531', '#2f4554', '#61a0a8', '#d48265', '#91c7ae']
                    });
                    
                    // 热销商品TOP10
                    this.salesTop10Chart = echarts.init(document.getElementById('salesTop10Chart'));
                    this.salesTop10Chart.setOption({
                        title: {
                            text: '',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function(params) {
                                if (!params || params.length === 0 || !params[0].data) return '';
                                
                                const data = params[0].data;
                                const salesAmount = parseFloat(data.value).toFixed(2);
                                const salesVolume = data.salesVolume || 0;
                                const avgPrice = salesVolume > 0 ? (parseFloat(data.value) / salesVolume).toFixed(2) : 0;
                                
                                return `
                                    <div style="font-weight:bold;margin-bottom:5px">${params[0].name}</div>
                                    <div>销售额: <span style="color:#c23531;font-weight:bold">¥${salesAmount.replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</span></div>
                                    <div>销量: <span style="color:#2f4554;font-weight:bold">${salesVolume}</span> 件</div>
                                    <div>均价: <span style="color:#61a0a8;font-weight:bold">¥${avgPrice}</span></div>
                                `;
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '8%',
                            bottom: '3%',
                            top: '10%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'value',
                            axisLabel: {
                                formatter: '¥{value}',
                                color: '#606266',
                                fontSize: 12
                            },
                            axisLine: {
                                lineStyle: {
                                    color: '#dcdfe6'
                                }
                            },
                            splitLine: {
                                lineStyle: {
                                    color: ['#ebeef5']
                                }
                            }
                        },
                        yAxis: {
                            type: 'category',
                            axisLine: {
                                lineStyle: {
                                    color: '#dcdfe6'
                                }
                            },
                            axisLabel: {
                                color: '#606266',
                                fontSize: 12,
                                width: 120,
                                overflow: 'truncate',
                                ellipsis: '...'
                            },
                            data: []
                        },
                        series: [
                            {
                                name: '销售额',
                                type: 'bar',
                                barWidth: '40%',
                                itemStyle: {
                                    color: function(params) {
                                        return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                            { offset: 0, color: '#c23531' },
                                            { offset: 0.5, color: '#d48265' },
                                            { offset: 1, color: '#ca8622' }
                                        ]);
                                    },
                                    borderRadius: [4, 4, 0, 0],
                                    shadowColor: 'rgba(0, 0, 0, 0.3)',
                                    shadowBlur: 5,
                                    shadowOffsetY: 3
                                },
                                label: {
                                    show: true,
                                    position: 'right',
                                    formatter: function(params) {
                                        return params.value ? '¥' + parseFloat(params.value).toFixed(2) : '';
                                    },
                                    color: '#606266',
                                    fontSize: 12
                                },
                                data: []
                            }
                        ],
                        dataZoom: [
                            {
                                type: 'slider',
                                yAxisIndex: 0,
                                filterMode: 'empty',
                                width: 12,
                                height: '80%',
                                handleSize: 8,
                                showDataShadow: false,
                                left: 'auto',
                                right: 3,
                                brushSelect: false
                            }
                        ]
                    });
                    
                    // 窗口大小变化时重新调整图表大小
                    window.addEventListener('resize', () => {
                        this.salesTrendChart && this.salesTrendChart.resize();
                        this.salesCategoryChart && this.salesCategoryChart.resize();
                        this.salesTop10Chart && this.salesTop10Chart.resize();
                    });
                },
                handleSearch() {
                    this.getStatistics();
                },
                resetSearch() {
                    this.searchForm.dateRange = [];
                    this.handleSearch();
                },
                async getStatistics() {
                    this.loading = true;
                    try {
                        const params = {
                            startDate: this.searchForm.dateRange ? this.searchForm.dateRange[0] : null,
                            endDate: this.searchForm.dateRange ? this.searchForm.dateRange[1] : null
                        };
                        const response = await axios.get('/sales/statistics', { params });
                        if (response.data.isOk) {
                            this.updateStatistics(response.data);
                            this.updateCharts(response.data);
                        } else {
                            this.$message.error(response.data.msg || '获取销售数据失败');
                        }
                    } catch (error) {
                        this.$message.error('获取销售数据失败');
                    } finally {
                        this.loading = false;
                    }
                },
                updateStatistics(data) {
                    // 计算总销售额、总订单数和平均客单价
                    let totalSales = 0;
                    let totalOrders = 0;
                    
                    if (data.statistics && Array.isArray(data.statistics)) {
                        data.statistics.forEach(item => {
                            if (item.total_sales) {
                                totalSales += parseFloat(item.total_sales);
                            }
                            if (item.order_count) {
                                totalOrders += parseInt(item.order_count);
                            }
                        });
                    }
                    
                    const avgPrice = totalOrders > 0 ? totalSales / totalOrders : 0;
                    
                    // 计算同比增长率（假设同比数据为0）
                    const salesGrowthRate = 0;
                    const orderGrowthRate = 0;
                    const avgPriceGrowthRate = 0;
                    const customerGrowthRate = 0;
                    
                    this.statistics = {
                        totalSales: totalSales,
                        salesGrowthRate: salesGrowthRate,
                        totalOrders: totalOrders,
                        orderGrowthRate: orderGrowthRate,
                        avgPrice: avgPrice,
                        avgPriceGrowthRate: avgPriceGrowthRate,
                        totalCustomers: data.totalCustomers || 0,
                        customerGrowthRate: customerGrowthRate
                    };
                },
                updateCharts(data) {
                    // 更新销售趋势图
                    if (data.trendData && data.trendData.length > 0) {
                        const trendOption = this.salesTrendChart.getOption();
                        
                        // 映射数据结构，兼容不同字段名
                        const trendData = data.trendData.map(item => ({
                            date: item.date || item.month || '',
                            salesAmount: parseFloat(item.total_sales || item.salesAmount || 0),
                            orderCount: parseInt(item.order_count || item.orderCount || 0)
                        })).filter(item => item.date); // 过滤无效数据
                        
                        if (trendData.length > 0) {
                            trendOption.xAxis[0].data = trendData.map(item => item.date);
                            trendOption.series[0].data = trendData.map(item => item.salesAmount);
                            trendOption.series[1].data = trendData.map(item => item.orderCount);
                            this.salesTrendChart.setOption(trendOption);
                            this.hasTrendData = true;
                        } else {
                            this.hasTrendData = false;
                        }
                    } else {
                        this.hasTrendData = false;
                    }
                    
                    // 更新品类销售占比图
                    if (data.categoryData && data.categoryData.length > 0) {
                        const categoryOption = this.salesCategoryChart.getOption();
                        
                        // 映射数据结构，兼容不同字段名
                        const categoryData = data.categoryData
                            .map(item => ({
                                value: parseFloat(item.total_sales || item.salesAmount || item.value || 0),
                                name: item.category_name || item.category || item.name || '未分类'
                            }))
                            .filter(item => item.value > 0); // 过滤无效数据
                        
                        if (categoryData.length > 0) {
                            // 计算总销售额，用于验证
                            const totalSales = categoryData.reduce((sum, item) => sum + item.value, 0);
                            console.log('品类总销售额:', totalSales);
                            
                            categoryOption.legend[0].data = categoryData.map(item => item.name);
                            categoryOption.series[0].data = categoryData;
                            this.salesCategoryChart.setOption(categoryOption);
                            this.hasCategoryData = true;
                        } else {
                            this.hasCategoryData = false;
                        }
                    } else {
                        this.hasCategoryData = false;
                    }
                    
                    // 更新热销商品TOP10图
                    if (data.topProducts && data.topProducts.length > 0) {
                        const topOption = this.salesTop10Chart.getOption();
                        
                        // 映射数据结构，兼容不同字段名
                        const topProducts = data.topProducts
                            .map(item => ({
                                value: parseFloat(item.sales_amount || item.total_sales || item.value || 0),
                                salesVolume: parseInt(item.sales_quantity || item.quantity || 0),
                                name: item.product_name || item.name || '未知商品'
                            }))
                            .filter(item => item.value > 0) // 过滤无效数据
                            .sort((a, b) => b.value - a.value) // 按销售额降序排序
                            .slice(0, 10); // 取前10条
                            
                        if (topProducts.length > 0) {
                            topOption.yAxis[0].data = topProducts.map(item => item.name);
                            topOption.series[0].data = topProducts.map(item => ({
                                value: item.value,
                                salesVolume: item.salesVolume
                            }));
                            this.salesTop10Chart.setOption(topOption, true);
                            this.hasTopProductsData = true;
                        } else {
                            this.hasTopProductsData = false;
                        }
                    } else {
                        this.hasTopProductsData = false;
                    }
                },
                handleMenuSelect(index) {
                    window.location.href = index;
                },
                handleCommand(command) {
                    if (command === 'logout') {
                        axios.get("/logout").finally(() => {
                            localStorage.removeItem('userId');
                            localStorage.removeItem('username');
                            window.location.href = 'managerLogin.html';
                        });
                    }
                }
            },
            beforeDestroy() {
                window.removeEventListener('resize', () => {});
            }
        });
    </script>
</body>
</html>