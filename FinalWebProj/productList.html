<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品管理系统</title>
    <!-- 使用CDN引入Element UI样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
    <style>
        .app-container {
            padding: 20px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
        .el-table .cell img {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        .status-active {
            color: #67C23A;
        }
        .status-inactive {
            color: #F56C6C;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    margin: 0;
    font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans', Arial, sans-serif;
}
.app-container {
    max-width: 1200px;
    margin: 40px auto 0 auto;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    padding: 32px 36px 36px 36px;
}
.el-breadcrumb {
    margin-bottom: 24px;
    font-size: 16px;
}
.search-container {
    margin-bottom: 28px;
    background: #f8fafc;
    padding: 18px 24px 8px 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.el-form-item {
    margin-right: 24px;
}
.el-button {
    border-radius: 8px !important;
    font-weight: 500;
    transition: box-shadow 0.2s;
}
.el-button:hover {
    box-shadow: 0 2px 8px rgba(253, 160, 133, 0.15);
}
.el-table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
}
.el-table th, .el-table td {
    font-size: 15px;
    padding: 12px 0;
}
.el-table .cell img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.el-table__row:hover {
    background: #fdf6ec !important;
}
.el-tag {
    border-radius: 8px !important;
    font-size: 14px;
    padding: 4px 14px;
}
.pagination-container {
    margin-top: 32px;
    text-align: center;
}
.el-pagination {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 10px 0;
}
@media (max-width: 900px) {
    .app-container {
        padding: 12px 4px;
    }
    .el-table th, .el-table td {
        font-size: 13px;
        padding: 8px 0;
    }
}
    </style>
</head>
<body style="margin:0;">
    <div id="app-layout" style="display: flex; height: 100vh;">
        <!-- 侧边导航栏 -->
        <div style="width:220px; min-height:100vh; background:#2d3a4b; display:flex; flex-direction:column; box-shadow:2px 0 8px rgba(0,0,0,0.08);">
            <div style="height:64px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:20px; font-weight:bold; letter-spacing:2px;">
                管理后台
            </div>
            <el-menu
                :default-active="activeMenu"
                class="el-menu-vertical-demo"
                background-color="#2d3a4b"
                text-color="#fff"
                active-text-color="#ffd04b"
                style="border-right:none; flex:1;"
                @select="handleMenuSelect">
                <el-menu-item index="productList.html">
                    <i class="el-icon-goods"></i>
                    <span slot="title">商品管理</span>
                </el-menu-item>
                <el-menu-item index="orderList.html">
                    <i class="el-icon-document"></i>
                    <span slot="title">订单管理</span>
                </el-menu-item>
                <el-menu-item index="CustomerList.html">
                    <i class="el-icon-user"></i>
                    <span slot="title">客户管理</span>
                </el-menu-item>
                <el-menu-item index="deliveryList.html">
                    <i class="el-icon-truck"></i>
                    <span slot="title">配送管理</span>
                </el-menu-item>
                <el-menu-item index="stockManagement.html">
                    <i class="el-icon-box"></i>
                    <span slot="title">库存管理</span>
                </el-menu-item>
                <el-menu-item index="statistics.html">
                    <i class="el-icon-s-data"></i>
                    <span slot="title">销售统计</span>
                </el-menu-item>
            </el-menu>
        </div>
        <!-- 主内容区 -->
        <div style="flex:1; display:flex; flex-direction:column; background:#f5f7fa; min-width:0;">
            <!-- 顶部栏 -->
            <div style="height: 64px; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; border-bottom: 1px solid #eee; background:#fff;">
                <el-dropdown @command="handleCommand">
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <el-avatar icon="el-icon-user-solid"></el-avatar>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
            <!-- 内容区 -->
            <div style="flex:1; padding:32px; overflow:auto; min-width:0;">
                <div id="app" class="app-container">
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item :to="{ path: 'managerMenu.html' }">首页</el-breadcrumb-item>
                        <el-breadcrumb-item>商品管理</el-breadcrumb-item>
                    </el-breadcrumb>
                    
                    <div class="search-container">
                        <el-form :inline="true" :model="searchForm" class="demo-form-inline">
                            <el-form-item label="商品名称">
                                <el-input v-model="searchForm.keyword" placeholder="商品名称" clearable></el-input>
                            </el-form-item>
                            <el-form-item label="商品分类">
                                <el-select v-model="searchForm.categoryId" placeholder="全部" clearable>
                                    <el-option v-for="item in categories" :key="item.categoryId" 
                                               :label="item.categoryName" :value="item.categoryId"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleSearch">查询</el-button>
                                <el-button @click="resetSearch">重置</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <el-button type="primary" @click="handleAdd">添加商品</el-button>
                        <el-button type="danger" @click="handleBatchDelete" :disabled="multipleSelection.length===0">批量删除</el-button>
                    </div>
                    
                    <el-table
                        :data="productList"
                        border
                        style="width: 100%"
                        @selection-change="handleSelectionChange">
                        <el-table-column
                          type="selection"
                          width="55">
                        </el-table-column>
                        <el-table-column
                          prop="productId"
                          label="商品ID"
                          width="80">
                        </el-table-column>
                        <el-table-column
                          prop="productName"
                          label="商品名称"
                          width="180">
                        </el-table-column>
                        <el-table-column
                          label="商品图片"
                          width="120">
                          <template slot-scope="scope">
                            <img :src="scope.row.imageUrl" v-if="scope.row.imageUrl" style="width: 60px; height: 60px;">
                            <span v-else>无图片</span>
                          </template>
                        </el-table-column>
                        <el-table-column
                          prop="categoryName"
                          label="分类"
                          width="120">
                        </el-table-column>
                        <el-table-column
                          prop="price"
                          label="价格"
                          width="120">
                          <template slot-scope="scope">¥{{scope.row.price.toFixed(2)}}</template>
                        </el-table-column>
                        <el-table-column
                          prop="stock"
                          label="库存"
                          width="80">
                        </el-table-column>
                        <el-table-column
                          prop="status"
                          label="状态"
                          width="100">
                          <template slot-scope="scope">
                            <el-tag :type="scope.row.status === 1 ? 'success' : 'danger'">
                              {{scope.row.status === 1 ? '上架' : '下架'}}
                            </el-tag>
                          </template>
                        </el-table-column>
                        <el-table-column
                          label="操作"
                          width="220">
                          <template slot-scope="scope">
                            <el-button size="mini" @click="handleEdit(scope.row)">编辑</el-button>
                            <el-button size="mini" type="danger" @click="handleDelete(scope.row)">删除</el-button>
                            <el-button size="mini" :type="scope.row.status === 1 ? 'warning' : 'success'" 
                                      @click="handleStatusChange(scope.row)">
                              {{scope.row.status === 1 ? '下架' : '上架'}}
                            </el-button>
                          </template>
                        </el-table-column>
                    </el-table>
                    
                    <div class="pagination-container">
                        <el-pagination
                          @size-change="handleSizeChange"
                          @current-change="handleCurrentChange"
                          :current-page="currentPage"
                          :page-sizes="[10, 20, 30, 50]"
                          :page-size="pageSize"
                          layout="total, sizes, prev, pager, next, jumper"
                          :total="total">
                        </el-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用CDN引入所有依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
    <script src="../axios.min.js"></script>
    
    <script>
        Vue.use(ELEMENT);
        axios.defaults.baseURL = 'http://localhost:9000';
        axios.defaults.withCredentials = true;
        
        new Vue({
            el: "#app-layout",
            data() {
                return {
                    activeMenu: 'productList.html',
                    productList: [], // 初始化为空数组
                    categories: [],  // 初始化为空数组
                    multipleSelection: [],
                    searchForm: {
                        keyword: '',
                        categoryId: ''
                    },
                    currentPage: 1,
                    pageSize: 10,
                    total: 0
                }
            },
            created() {
                // 页面加载时自动获取数据
                this.getProductList();
                this.getCategories();
            },
            methods: {
                getProductList() {
                    this.loading = true;
                    const params = {
                        pageNum: this.currentPage,
                        pageSize: this.pageSize,
                        keyword: this.searchForm.keyword,
                        categoryId: this.searchForm.categoryId
                    };
                    axios.get('/product/list', { params })
                        .then(response => {
                            console.log('商品列表响应:', response.data);
                            
                            // 尝试多种数据格式
                            let productList = [];
                            let total = 0;
                            
                            if (response.data.code === 200) {
                                // 格式1: {code: 200, data: {list: [], total: 0}}
                                if (response.data.data && response.data.data.list) {
                                    productList = response.data.data.list;
                                    total = response.data.data.total || 0;
                                }
                                // 格式2: {code: 200, list: [], total: 0}
                                else if (response.data.list) {
                                    productList = response.data.list;
                                    total = response.data.total || 0;
                                }
                                // 格式3: 直接返回数组
                                else if (Array.isArray(response.data)) {
                                    productList = response.data;
                                    total = response.data.length;
                                }
                                // 格式4: 其他格式
                                else {
                                    console.warn('未知的数据格式:', response.data);
                                    productList = [];
                                    total = 0;
                                }
                            } else {
                                this.$message.error(response.data.message || '获取商品数据失败');
                            }
                            
                            this.productList = productList;
                            this.total = total;
                            
                            console.log('解析后的数据:', {
                                productList: this.productList,
                                total: this.total
                            });
                        })
                        .catch((error) => {
                            console.error('获取商品数据失败:', error);
                            this.$message.error('获取商品数据失败: ' + (error.response?.data?.message || error.message));
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                getCategories() {
                    axios.get('/product/category/list')
                        .then(response => {
                            console.log('分类数据响应:', response.data);
                            
                            let categories = [];
                            if (response.data.code === 200) {
                                // 尝试多种数据格式
                                if (response.data.data) {
                                    categories = response.data.data;
                                } else if (Array.isArray(response.data)) {
                                    categories = response.data;
                                } else {
                                    console.warn('未知的分类数据格式:', response.data);
                                }
                            } else {
                                this.$message.error(response.data.message || '获取分类数据失败');
                            }
                            
                            this.categories = categories;
                            console.log('解析后的分类数据:', this.categories);
                        })
                        .catch((error) => {
                            console.error('获取分类数据失败:', error);
                            this.$message.error('获取分类数据失败: ' + (error.response?.data?.message || error.message));
                        });
                },
                handleSearch() {
                    this.currentPage = 1;
                    this.getProductList();
                },
                resetSearch() {
                    this.searchForm = {
                        keyword: '',
                        categoryId: ''
                    };
                    this.handleSearch();
                },
                handleAdd() {
                    window.location.href = 'productAdd.html';
                },
                handleEdit(row) {
                    window.location.href = `productEdit.html?id=${row.productId}`;
                },
                handleDelete(row) {
                    this.$confirm('确认删除该商品吗? 删除后不可恢复', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        return axios.post(`/product/delete/${row.productId}`)
                            .then((res) => {
                                if (res.data.code === 200) {
                                    this.$message.success(res.data.message);
                                    this.getProductList();
                                } else {
                                    this.$message.error(res.data.message);
                                }
                            })
                            .catch((error) => {
                                console.error('删除失败:', error);
                                this.$message.error('删除失败: ' + (error.response?.data?.message || error.message));
                            });
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },
                handleBatchDelete() {
                    if (this.multipleSelection.length === 0) {
                        this.$message.warning('请选择要删除的商品');
                        return;
                    }
                    
                    this.$confirm(`确认删除选中的${this.multipleSelection.length}件商品吗? 删除后不可恢复`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const ids = this.multipleSelection.map(item => item.productId);
                        return axios.post("/product/batchDelete", ids)
                            .then((res) => {
                                if (res.data.code === 200) {
                                    this.$message.success(res.data.message);
                                    this.getProductList();
                                    this.multipleSelection = [];
                                } else {
                                    this.$message.error(res.data.message);
                                }
                            })
                            .catch((error) => {
                                console.error('批量删除失败:', error);
                                this.$message.error('批量删除失败: ' + (error.response?.data?.message || error.message));
                            });
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },
                handleStatusChange(row) {
                    const newStatus = row.status === 1 ? 0 : 1;
                    this.$confirm(`确认将商品状态改为${newStatus === 1 ? '上架' : '下架'}吗?`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: newStatus === 1 ? 'success' : 'warning'
                    }).then(() => {
                        return axios.post(`/product/updateStatus/${row.productId}?status=${newStatus}`)
                            .then((res) => {
                                if (res.data.code === 200) {
                                    this.$message.success(res.data.message);
                                    row.status = newStatus;
                                } else {
                                    this.$message.error(res.data.message);
                                }
                            })
                            .catch((error) => {
                                console.error('状态更新失败:', error);
                                this.$message.error('状态更新失败: ' + (error.response?.data?.message || error.message));
                            });
                    }).catch(() => {
                        this.$message.info('已取消更新');
                    });
                },
                handleSelectionChange(val) {
                    this.multipleSelection = val;
                },
                handleSizeChange(val) {
                    this.pageSize = val;
                    this.getProductList();
                },
                handleCurrentChange(val) {
                    this.currentPage = val;
                    this.getProductList();
                },
                handleMenuSelect(index) {
                    window.location.href = index;
                },
                handleCommand(command) {
                    if (command === 'logout') {
                        axios.get("/logout").finally(() => {
                            localStorage.removeItem('userId');
                            localStorage.removeItem('username');
                            window.location.href = 'managerLogin.html';
                        });
                    }
                }
            },
            mounted() {
                // 激活菜单
                this.activeMenu = 'productList.html';
            }
        });
    </script>
</body>
</html>